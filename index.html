<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Peptide Calculator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f0f12;--card:#15161a;--ink:#e7e7ea;--muted:#9aa0ab;
    --accent:#7c5cff;--accent-2:#25d0a6;--error:#ff6b6b;
    /* SUBQ overlay percent box (relative to the image) */
    --b-left:36.50%; --b-right:28.50%; --b-top:42.50%; --b-height:13.50%;
    /* optional pixel nudge for the blue fill only (debug) */
    --barrel-shift:0px;
  }
  *{box-sizing:border-box}
  html{-webkit-text-size-adjust:100%}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:radial-gradient(1100px 700px at 100% -50%, #1b1c22 30%, #0f0f12 70%),var(--bg);
    color:var(--ink)
  }
  .wrap{max-width:1080px;margin:auto;padding:24px}
  header{display:flex;gap:14px;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#0d0e12;border:1px solid #2a2c33}
  .logo img{width:100%;height:100%;object-fit:contain;display:block}
  h1{font-size:clamp(22px,3vw,32px);margin:0;font-weight:800;letter-spacing:-0.02em}

  .card{background:linear-gradient(180deg, #1a1b21, #131419);border:1px solid #23242b;box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);border-radius:16px;padding:18px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}

  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .field{grid-column:span 6}
  .field.sm{grid-column:span 4}

  .input{
    width:100%;background:#0d0e12;color:var(--ink);border:1px solid #2a2c33;border-radius:12px;
    padding:12px 14px;font-size:16px;line-height:1.3;min-height:46px;caret-color:#fff;
    outline:2px solid transparent;outline-offset:2px;transition:border .15s ease, outline .15s ease;text-align:left
  }
  .input:focus{border-color:#5c6ae6;outline-color:#3d44a3}

  /* Desired dose wider on phones */
  .field.dose { grid-column: span 8; }
  @media (max-width:900px){ .field.dose { grid-column: span 12; } }

  .dose-group{display:grid;grid-template-columns:1fr 110px;gap:8px}
  .unit-select{width:110px;min-height:46px;font-size:16px}
  @media (max-width:420px){
    .dose-group{grid-template-columns:1fr 96px}
    .unit-select{width:96px}
  }

  /* Number input visibility fixes */
  input[type="number"]{appearance:textfield;-webkit-appearance:textfield;-webkit-text-fill-color:var(--ink);color:var(--ink);background-color:#0d0e12}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  ::placeholder{color:var(--muted);opacity:.8}

  .btns{display:flex;flex-wrap:wrap;gap:10px}
  button.pill{background:#0d0e12;border:1px solid #2a2c33;color:var(--ink);padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:600}
  button.pill[aria-pressed="true"],button.pill:hover{border-color:#4d8cff;background:#111424}
  .muted{color:var(--muted)}
  .big{font-size:clamp(18px,3vw,24px);font-weight:800}

  /* Classic syringe visual */
  .syringe{background:#0c0d11;border:1px solid #272930;border-radius:14px;padding:18px}
  .syringe h3{margin:0 0 10px 0;font-size:18px}
  .tube{position:relative;height:36px;border-radius:18px;background:linear-gradient(180deg,#11131a,#0b0c10);border:1px solid #2a2c33;box-shadow:inset 0 2px 8px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.05)}
  .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg, var(--accent), #5b9dff);border-radius:18px;box-shadow:inset 0 0 12px rgba(255,255,255,.25), 0 0 16px rgba(124,92,255,.45)}
  .cap{position:absolute;left:-8px;top:50%;translate:0 -50%;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#4e556a,#262a33);border:1px solid #6b7388}
  .ticks{position:relative;display:flex;justify-content:space-between;align-items:flex-start;margin-top:10px;padding:0 2px}
  .tick{position:relative;width:1px;background:#3a3d47}
  .tick.minor{height:10px;opacity:.55}
  .tick.major{height:16px}
  .tick .n{position:absolute;top:18px;left:50%;transform:translateX(-50%);font-size:12px;color:var(--muted)}
  .cursor{position:absolute;top:-8px;width:2px;background:var(--accent-2);height:52px;border-radius:2px;box-shadow:0 0 0 2px rgba(37,208,166,.15)}

  .note{font-size:13px;color:var(--muted)}
  .result{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:26px}
  .chip{background:#0c0d11;border:1px solid #2a2c33;border-radius:12px;padding:10px 12px}
  .chip .k{color:var(--muted);font-size:12px}
  .chip .v{font-weight:800;font-size:18px}
  .warn{color:var(--error);font-weight:700}
  footer{margin-top:26px;color:var(--muted);font-size:12px}
  a{color:#8fb6ff}

  /* Tabs */
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tabs .pill{padding:8px 12px}
  .tabs .pill[aria-pressed="true"]{background:#1a1d2b;border-color:#4d8cff}

  /* SUBQ Syringe overlayed on the image */
  .subq-card{background:linear-gradient(180deg, #1a1b21, #131419);border:1px solid #23242b;border-radius:16px;padding:18px}
  .subq-wrapper{position:relative;display:block;width:100%;max-width:980px;margin:8px auto 0}
  .subq-wrapper img{display:block;width:100%;height:auto;border-radius:10px}
  .subq-overlay{
    position:absolute;
    pointer-events:none; /* do not block UI */
    left:var(--b-left); right:var(--b-right); top:var(--b-top);
    height:var(--b-height);
    display:flex; align-items:center; justify-content:center;
  }
  .subq-track{
    position:relative;width:100%;height:100%;
    background:rgba(10,12,16,.55);
    border:1px solid rgba(255,255,255,.08);
    border-radius:16px; backdrop-filter: blur(2px);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 0 0 1px rgba(0,0,0,.35);
  }
  .subq-fill{
    position:absolute;left:calc(0px + var(--barrel-shift));top:2px;bottom:2px;width:0%;
    background:linear-gradient(90deg,var(--accent),#5b9dff);
    border-radius:14px; box-shadow:inset 0 0 10px rgba(255,255,255,.2),0 0 12px rgba(124,92,255,.35)
  }
  .subq-cursor{
    position:absolute;top:-8px;width:3px;height:calc(100% + 16px);
    background:var(--accent-2);border-radius:2px;box-shadow:0 0 0 2px rgba(37,208,166,.15)
  }
  .subq-ticks{position:absolute;left:8px;right:8px;bottom:6px;height:16px}
  .subq-tick{position:absolute;width:1px;background:#3a3d47;opacity:.9}
  .subq-tick.min{height:6px}
  .subq-tick.mid{height:9px}
  .subq-tick.maj{height:12px}
  .subq-num{
    position:absolute;bottom:-16px;
    font-size:clamp(10px, 0.95vw, 14px);
    color:#cfd4df;transform:translateX(-50%);white-space:nowrap;letter-spacing:0.02em
  }

  /* Debug HUD */
  .hud{
    position:fixed;left:12px;bottom:12px;background:rgba(10,12,16,.85);
    color:#dbe1ff;border:1px solid rgba(255,255,255,.1);border-radius:12px;
    padding:10px 12px;font-size:12px;line-height:1.5;z-index:9999;display:none
  }
  .hud kbd{
    background:#1e2435;border:1px solid #34405c;border-radius:6px;
    padding:0 6px;margin:0 2px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:11px;color:#e6edff
  }
  .hud.show{display:block}
</style>
</head>
<body>

<!-- Hero banner (tight spacing) -->
<img src="IMG_20250926_184644.png" alt="SUBQ SOCIETY – THE UNDERGROUND PROTOCOL"
     style="max-width:100%;height:auto;display:block;margin:0 auto 12px auto">

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><img src="IMG_20250926_184642.png" alt="Snake syringe logo"></div>
      <h1>Peptide Calculator</h1>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Inputs -->
    <section class="card" aria-labelledby="inputsTitle">
      <h2 id="inputsTitle" class="big" style="margin:6px 0 12px">Setup</h2>
      <div class="row">
        <div class="field sm">
          <label for="vialMg">Peptide per vial (mg)</label>
          <input id="vialMg" class="input" type="number" step="0.1" value="5" />
        </div>
        <div class="field sm">
          <label for="diluentMl">Diluent added (mL)</label>
          <input id="diluentMl" class="input" type="number" step="0.1" value="1" />
        </div>
        <div class="field sm">
          <label for="syrSize">Syringe size (units scale)</label>
          <select id="syrSize" class="input">
            <option value="30">30-unit (short)</option>
            <option value="50">50-unit</option>
            <option value="100" selected>100-unit</option>
          </select>
        </div>
        <!-- Desired dose (value + unit) -->
        <div class="field sm dose">
          <label for="doseVal">Desired dose</label>
          <div class="dose-group">
            <input id="doseVal" class="input" type="number" step="0.001" min="0" value="0.5"
                   inputmode="decimal" placeholder="Enter dose" />
            <select id="doseUnit" class="input unit-select">
              <option value="mcg">mcg</option>
              <option value="mg" selected>mg</option>
            </select>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Quick select dose</label>
        <!-- mcg presets -->
        <div id="presets-mcg" class="btns" role="group" aria-label="Preset doses (mcg)" style="display:none">
          <button class="pill preset" data-dose="50" data-unit="mcg">50 mcg</button>
          <button class="pill preset" data-dose="100" data-unit="mcg">100 mcg</button>
          <button class="pill preset" data-dose="250" data-unit="mcg">250 mcg</button>
          <button class="pill preset" data-dose="500" data-unit="mcg">500 mcg</button>
        </div>
        <!-- mg presets -->
        <div id="presets-mg" class="btns" role="group" aria-label="Preset doses (mg)">
          <button class="pill preset" data-dose="1"  data-unit="mg">1 mg</button>
          <button class="pill preset" data-dose="2"  data-unit="mg">2 mg</button>
          <button class="pill preset" data-dose="5"  data-unit="mg">5 mg</button>
          <button class="pill preset" data-dose="10" data-unit="mg">10 mg</button>
        </div>
      </div>

      <p class="note" style="margin-top:10px">Assumes a U-100 insulin syringe where
        <strong>1 unit = 0.01 mL</strong>. Calculations update as you type.</p>
    </section>

    <!-- RIGHT: Visual Aid with tabs -->
    <section class="subq-card" aria-labelledby="visTitle">
      <div class="tabs" role="tablist" aria-label="Visual">
        <button id="tabSubq" class="pill" role="tab" aria-selected="true" aria-controls="panelSubq">SUBQ Syringe</button>
        <button id="tabClassic" class="pill" role="tab" aria-selected="false" aria-controls="panelClassic">Classic</button>
      </div>

      <h2 id="visTitle" class="big" style="margin:6px 0 12px">
        To have a dose of <span id="doseOut">0.5</span> <span id="doseUnitLabel">mg</span>
        pull the syringe to <span id="unitsOut">—</span> <span id="unitWord">units</span>
      </h2>

      <!-- SUBQ Syringe panel -->
      <div id="panelSubq" role="tabpanel" aria-labelledby="tabSubq">
        <div class="subq-wrapper">
          <img src="IMG_20250928_220440.png" alt="SUBQ snake syringe">
          <div class="subq-overlay" id="subqOverlay">
            <div class="subq-track">
              <div class="subq-fill" id="subqFill"></div>
              <div class="subq-cursor" id="subqCursor"></div>
              <div class="subq-ticks" id="subqTicks"></div>
            </div>
          </div>
        </div>

        <div class="result" style="margin-top:18px">
          <div class="chip">
            <div class="k">Units to pull</div>
            <div class="v" id="unitsOutChip">—</div>
            <div class="k" style="margin-top:4px">≈ <span id="mlOut">—</span></div>
          </div>
          <div class="chip">
            <div class="k">Potency</div>
            <div class="v" id="potencyOut">—</div>
            <div class="k"><span id="potencyUnitLabel">mg</span> per unit</div>
          </div>
        </div>
        <p id="warn" class="note" style="margin-top:8px"></p>
      </div>

      <!-- Classic panel -->
      <div id="panelClassic" style="display:none" role="tabpanel" aria-labelledby="tabClassic">
        <div class="syringe" aria-live="polite">
          <div class="tube" id="tube">
            <div class="fill" id="fill"></div>
            <div class="cursor" id="cursor" aria-hidden="true"></div>
          </div>
          <div class="ticks" id="ticks" aria-hidden="true"></div>

          <div class="result">
            <div class="chip">
              <div class="k">Units to pull</div>
              <div class="v" id="unitsOutChipC">—</div>
              <div class="k" style="margin-top:4px">≈ <span id="mlOutC">—</span></div>
            </div>
            <div class="chip">
              <div class="k">Potency</div>
              <div class="v" id="potencyOutC">—</div>
              <div class="k"><span id="potencyUnitLabelC">mg</span> per unit</div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <p class="note">This calculator is for educational use only. Not medical advice.</p>
      </footer>
    </section>
  </div>
</div>

<!-- Debug HUD -->
<div id="hud" class="hud" aria-live="polite">
  <strong>Debug mode</strong> — Press <kbd>D</kbd> to toggle<br>
  Overlay (%): <kbd>←</kbd>/<kbd>→</kbd> = Left, <kbd>↑</kbd>/<kbd>↓</kbd> = Top (hold <kbd>Shift</kbd> for ×4)<br>
  Overlay fine (%): Left <kbd>;</kbd>/<kbd>'</kbd>, Right <kbd>[</kbd>/<kbd>]</kbd>, Top <kbd>,</kbd>/<kbd>.</kbd>, Height <kbd>-</kbd>/<kbd>=</kbd><br>
  Fill (px): <kbd>Q</kbd>/<kbd>E</kbd> (optional tiny nudge)<br>
  <span id="hudVals"></span>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = (id) => document.getElementById(id);

  // Inputs
  const vialMg = $('vialMg');
  const diluentMl = $('diluentMl');
  const syrSize  = $('syrSize');
  const doseVal  = $('doseVal');
  const doseUnit = $('doseUnit');

  // Outputs
  const doseOut = $('doseOut');
  const doseUnitLabel = $('doseUnitLabel');
  const unitsOut = $('unitsOut');
  const unitWord = $('unitWord');
  const mlOut = $('mlOut');
  const potencyOut = $('potencyOut');
  const potencyUnitLabel = $('potencyUnitLabel');
  const unitsOutChip = $('unitsOutChip');
  const warnEl = $('warn');

  // Classic outputs
  const fill = $('fill');
  const cursor = $('cursor');
  const ticks = $('ticks');
  const unitsOutChipC = $('unitsOutChipC');
  const mlOutC = $('mlOutC');
  const potencyOutC = $('potencyOutC');
  const potencyUnitLabelC = $('potencyUnitLabelC');

  // SUBQ overlay elements
  const subqOverlay = $('subqOverlay');
  const subqFill    = $('subqFill');
  const subqCursor  = $('subqCursor'); // thin green bar
  const subqTicks   = $('subqTicks');

  // Tabs
  const tabSubq = $('tabSubq');
  const tabClassic = $('tabClassic');
  const panelSubq = $('panelSubq');
  const panelClassic = $('panelClassic');

  // Presets
  const presetsMcg = $('presets-mcg');
  const presetsMg  = $('presets-mg');

  // Debug HUD
  const hud = $('hud');
  const hudVals = $('hudVals');
  let debug = false;

  const clamp=(n,min,max)=>Math.min(max,Math.max(min,n));
  const fmt=(n,d=2)=>Number.isFinite(n)?n.toFixed(d).replace(/\.0+$/,'').replace(/(\.[1-9]*)0+$/,'$1'):'—';

  // TABS
  const setTab = (which) => {
    if (which==='subq'){
      tabSubq.setAttribute('aria-pressed','true'); tabSubq.setAttribute('aria-selected','true');
      tabClassic.setAttribute('aria-pressed','false'); tabClassic.setAttribute('aria-selected','false');
      panelSubq.style.display='block'; panelClassic.style.display='none';
    } else {
      tabSubq.setAttribute('aria-pressed','false'); tabSubq.setAttribute('aria-selected','false');
      tabClassic.setAttribute('aria-pressed','true'); tabClassic.setAttribute('aria-selected','true');
      panelSubq.style.display='none'; panelClassic.style.display='block';
    }
  };
  tabSubq.addEventListener('click',()=>setTab('subq'));
  tabClassic.addEventListener('click',()=>setTab('classic'));
  setTab('subq');

  // Build tick marks for Classic
  function buildTicksClassic(){
    ticks.innerHTML='';
    const max=parseInt(syrSize.value,10)||30;
    const minorStep=(max<=30?1:5);
    const majorStep=(max<=30?5:10);
    for(let i=0;i<=max;i+=minorStep){
      const t=document.createElement('div');
      t.className='tick '+(i%majorStep===0?'major':'minor');
      if(i%majorStep===0){
        const n=document.createElement('div'); n.className='n'; n.textContent=String(i); t.appendChild(n);
      }
      ticks.appendChild(t);
    }
  }

  // Build tick marks for SUBQ overlay with anti-overlap labels
  function buildTicksSubq(){
    subqTicks.innerHTML='';
    const max = parseInt(syrSize.value,10) || 30;

    // Minor tick spacing:
    // - U-100: 2-unit minis (4 between each labeled 10)
    // - U-50 : 1-unit minis, majors every 5
    // - U-30 : 1-unit minis, majors every 5
    const minorStep = (max===100) ? 2 : 1;
    const majorStep = (max===100) ? 10 : (max<=30 ? 5 : 5);

    const track = subqOverlay.querySelector('.subq-track');
    const padL = 8, padR = 8;  // match .subq-ticks left/right
    const widthPx = Math.max(0, track.clientWidth - (padL + padR));
    const pxPerUnit = widthPx / max;

    // Minimum gap between printed numbers (in px)
    // This prevents crowding at 100% zoom on smaller screens.
    const minLabelGap = 13;   // try 18–22px; adjust to taste
    let lastLabelX = -Infinity;

    // Draw minor ticks at every 'minorStep', mid-ticks at 5-unit marks (when sensible), majors at 'majorStep'
    for(let i=0;i<=max;i+=minorStep){
      const x = (i/max) * 100; // percent within ticks box

      const tick = document.createElement('div');
      tick.className = 'subq-tick min';
      tick.style.left = `calc(${x}% - 0.5px)`;

      // mid tick (half of a major step), only for U-100 -> at every 5
      if (max===100 && i%5===0 && i%10!==0) tick.className = 'subq-tick mid';

      // major tick
      if (i%majorStep===0) tick.className = 'subq-tick maj';

      subqTicks.appendChild(tick);

      // Number labels only at 10s (or majors for 30/50). Use anti-overlap rule.
      const showNumber = (max===100) ? (i%10===0) : (i%majorStep===0);
      if (showNumber){
        const xPx = i * pxPerUnit;
        if (xPx - lastLabelX >= minLabelGap || i===0){
          const lab = document.createElement('div');
          lab.className = 'subq-num';
          lab.style.left = (x) + '%';
          lab.textContent = String(i);
          subqTicks.appendChild(lab);
          lastLabelX = xPx;
        }
      }
    }
  }

  // Dose helpers
  function getDesiredDoseMcg(){
    const val=parseFloat(doseVal.value);
    if(!Number.isFinite(val)||val<=0) return NaN;
    return (doseUnit.value==='mg')? val*1000 : val;
  }

  function recalc(){
    const mg=parseFloat(vialMg.value);
    const ml=parseFloat(diluentMl.value);
    const maxUnits=parseInt(syrSize.value,10)||30;

    const conc = (mg>0 && ml>0) ? (mg/ml) : NaN; // mg/mL
    const mcgPerUnit = Number.isFinite(conc)? conc*10 : NaN; // (mg/mL)*(mL/Unit)*1000
    const mgPerUnit  = Number.isFinite(mcgPerUnit)? (mcgPerUnit/1000) : NaN;

    const desiredMcg = getDesiredDoseMcg();
    const units = (Number.isFinite(mcgPerUnit) && Number.isFinite(desiredMcg)) ? (desiredMcg/mcgPerUnit) : NaN;
    const mlToPull = Number.isFinite(units)? units*0.01 : NaN;

    // Top header + SUBQ stats
    if(doseUnit.value==='mg'){
      doseOut.textContent=fmt(desiredMcg/1000,3);
      doseUnitLabel.textContent='mg';
      potencyOut.textContent=Number.isFinite(mgPerUnit)?fmt(mgPerUnit,4):'—';
      potencyUnitLabel.textContent='mg';
    }else{
      doseOut.textContent=fmt(desiredMcg,0);
      doseUnitLabel.textContent='mcg';
      potencyOut.textContent=Number.isFinite(mcgPerUnit)?fmt(mcgPerUnit,2):'—';
      potencyUnitLabel.textContent='mcg';
    }
    unitsOut.textContent=fmt(units,2);
    unitsOutChip.textContent=Number.isFinite(units)?fmt(units,2):'—';
    mlOut.textContent=Number.isFinite(mlToPull)?`${fmt(mlToPull,3)} mL`:'—';
    if(Number.isFinite(units)) unitWord.textContent=Math.abs(units-1)<0.005?'unit':'units';

    // SUBQ overlay fill + cursor
    const pct=Number.isFinite(units)?clamp(units/maxUnits*100,0,100):0;
    subqFill.style.width=pct+'%';
    subqCursor.style.left=`calc(${pct}% - 1.5px)`; // thin green line

    // Classic view mirrors
    if(doseUnit.value==='mg'){
      potencyOutC.textContent=Number.isFinite(mgPerUnit)?fmt(mgPerUnit,4):'—';
      potencyUnitLabelC.textContent='mg';
    }else{
      potencyOutC.textContent=Number.isFinite(mcgPerUnit)?fmt(mcgPerUnit,2):'—';
      potencyUnitLabelC.textContent='mcg';
    }
    unitsOutChipC.textContent=Number.isFinite(units)?fmt(units,2):'—';
    mlOutC.textContent=Number.isFinite(mlToPull)?`${fmt(mlToPull,3)} mL`:'—';
    fill.style.width=pct+'%';
    cursor.style.left=`calc(${pct}% - 1px)`;

    // Warnings
    warnEl.textContent=''; warnEl.classList.remove('warn');
    if(!Number.isFinite(units)){
      warnEl.textContent='Enter positive values for vial mg, diluent mL, and dose.';
    }else if(units>maxUnits){
      warnEl.textContent=`⚠️ Dose exceeds the selected syringe scale of ${maxUnits} units.`; warnEl.classList.add('warn');
    }
  }

  // Wire presets
  function wirePresets(row){
    row.querySelectorAll('.preset').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.preset').forEach(b=>b.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        doseUnit.value = btn.dataset.unit;
        doseVal.value  = btn.dataset.dose;
        togglePresetRows();
        recalc();
      });
    });
  }
  function togglePresetRows(){
    const useMg = (doseUnit.value === 'mg');
    presetsMg.style.display  = useMg ? 'flex' : 'none';
    presetsMcg.style.display = useMg ? 'none' : 'flex';
    doseUnitLabel.textContent   = useMg ? 'mg'  : 'mcg';
    potencyUnitLabel.textContent= useMg ? 'mg'  : 'mcg';
    potencyUnitLabelC.textContent= useMg ? 'mg' : 'mcg';
  }
  function convertOnUnitChange(prev,next){
    const val=parseFloat(doseVal.value);
    if(!Number.isFinite(val)||prev===next) return;
    doseVal.value = (prev==='mcg'&&next==='mg') ? (val/1000) : (prev==='mg'&&next==='mcg') ? (val*1000) : val;
  }

  ['input','change'].forEach(evt=>{
    [vialMg,diluentMl,syrSize,doseVal].forEach(el=>{
      el.addEventListener(evt,()=>{
        if(el===syrSize){ buildTicksClassic(); buildTicksSubq(); }
        recalc();
      });
    });
  });
  doseUnit.addEventListener('change',()=>{
    const prev=(doseUnit.dataset.prev||'mg'), next=doseUnit.value;
    convertOnUnitChange(prev,next);
    doseUnit.dataset.prev=next;
    togglePresetRows();
    document.querySelectorAll('.preset').forEach(b=>b.setAttribute('aria-pressed','false'));
    recalc();
  });

  wirePresets(presetsMg); wirePresets(presetsMcg);
  doseUnit.dataset.prev=doseUnit.value;
  buildTicksClassic(); buildTicksSubq();
  togglePresetRows(); recalc();

  /* ----------------- Developer Mode (overlay inside image) ----------------- */
  const getVar = (name, fallback) => {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if(!v) return fallback;
    if(v.endsWith('%')) return parseFloat(v);
    if(v.endsWith('px')) return parseFloat(v);
    return parseFloat(v);
  };
  const setVar = (name, val) => document.documentElement.style.setProperty(name, val.toFixed(2)+'%');
  const setVarPx = (name, val) => document.documentElement.style.setProperty(name, Math.round(val)+'px');
  const pct = (n)=>Math.max(0,Math.min(100,n));

  let L=getVar('--b-left',15), R=getVar('--b-right',19), T=getVar('--b-top',46.5), H=getVar('--b-height',13);
  let S=getVar('--barrel-shift',0); // px
  const stepPct=0.25, stepPx=1;

  const refreshHUD=()=>{
    hudVals.textContent = `--b-left: ${L.toFixed(2)}% | --b-right: ${R.toFixed(2)}% | --b-top: ${T.toFixed(2)}% | --b-height: ${H.toFixed(2)}% | --barrel-shift: ${S.toFixed(1)}px`;
  };

  document.addEventListener('keydown',(e)=>{
    if(e.key==='d' || e.key==='D'){
      debug=!debug; hud.classList.toggle('show',debug); refreshHUD(); return;
    }
    if(!debug) return;

    const big = e.shiftKey? 4:1;
    switch(e.key){
      // Fine overlay (%)
      case ';': L=pct(L-stepPct); setVar('--b-left',L); break;
      case "'": L=pct(L+stepPct); setVar('--b-left',L); break;
      case '[': R=pct(R-stepPct); setVar('--b-right',R); break;
      case ']': R=pct(R+stepPct); setVar('--b-right',R); break;
      case ',': T=pct(T-stepPct); setVar('--b-top',T); break;
      case '.': T=pct(T+stepPct); setVar('--b-top',T); break;
      case '-': H=pct(H-stepPct); setVar('--b-height',H); break;
      case '=': H=pct(H+stepPct); setVar('--b-height',H); break;

      // Coarse overlay with arrows
      case 'ArrowLeft':  L=pct(L-(stepPct*big)); setVar('--b-left',L); break;
      case 'ArrowRight': L=pct(L+(stepPct*big)); setVar('--b-left',L); break;
      case 'ArrowUp':    T=pct(T-(stepPct*big)); setVar('--b-top',T); break;
      case 'ArrowDown':  T=pct(T+(stepPct*big)); setVar('--b-top',T); break;

      // Optional blue fill pixel nudge
      case 'q': case 'Q': S-=stepPx*big; setVarPx('--barrel-shift',S); break;
      case 'e': case 'E': S+=stepPx*big; setVarPx('--barrel-shift',S); break;

      default: return;
    }
    e.preventDefault();
    refreshHUD();
  });

});
</script>
</body>
</html>
